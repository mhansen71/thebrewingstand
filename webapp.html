<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemist's Apprentice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic styling enhancements */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align container to top */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Main game container */
        #game-container {
            background-color: #d2b48c;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 4px solid #a0522d;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        /* Start screen overlay */
        #start-screen {
            position: fixed; /* Overlay */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            padding: 20px;
            box-sizing: border-box;
        }
        #start-box {
            background-color: #d2b48c; /* Match game container */
            padding: 30px;
            border-radius: 8px;
            border: 4px solid #a0522d;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            text-align: center;
            color: #3a3a3a;
            max-width: 500px;
        }
        #start-box h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #start-box p {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        #start-game-button {
            padding: 12px 25px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #start-game-button:hover {
            background-color: #4cae4c;
        }

        /* Other styles */
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #3a3a3a;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid #a0522d;
            padding-bottom: 5px;
            flex-shrink: 0;
        }
        .potion-display-area {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 1rem;
             margin-bottom: 0.25rem;
             flex-shrink: 0;
        }
        .potion-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #eee;
            padding: 10px;
            border-radius: 4px;
            border: 2px solid #ccc;
            overflow: hidden;
            min-height: 120px; /* Ensure space for name */
        }
        .potion-display img {
            width: 64px;
            height: 64px;
            margin-bottom: 5px;
            image-rendering: pixelated;
            border: 1px solid #888;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7em;
            color: #aaa;
            flex-shrink: 0;
        }
        .potion-display span {
            font-weight: bold;
            color: #555;
            text-align: center;
            word-break: break-word;
        }
         #ingredient-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            background-color: #c6c6c6;
            padding: 15px;
            border-radius: 4px;
            border: 2px solid #8b8b8b;
            margin-bottom: 20px;
        }
        .ingredient-card {
            background-color: #e0e0e0;
            border: 2px solid #a0a0a0;
            border-radius: 4px;
            padding: 8px;
            padding-top: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, opacity 0.3s;
            min-height: 90px;
            aspect-ratio: 1 / 1;
        }
        .ingredient-card:hover {
            background-color: #f5f5f5;
            border-color: #777;
        }
        .ingredient-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background-color: #ccc;
            border-color: #aaa;
        }
        .ingredient-card.disabled:hover {
             background-color: #ccc;
             border-color: #aaa;
        }
        .ingredient-card img {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            image-rendering: pixelated;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7em;
            color: #aaa;
            background-color: #fff;
            border: 1px solid #ccc;
             flex-shrink: 0;
        }
         .ingredient-card span {
            font-size: 0.85em;
            text-align: center;
            color: #333;
            word-break: break-word;
            line-height: 1.2;
         }
        #feedback {
            margin-top: 15px;
            padding: 10px;
            background-color: #fffacd;
            border: 1px solid #fadf8a;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            min-height: 40px;
            word-wrap: break-word;
            flex-shrink: 0;
        }
        #new-game-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-top: 20px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        #new-game-button:hover {
            background-color: #4cae4c;
        }
        #timer-container {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
            background-color: #eee;
            padding: 5px;
            border-radius: 4px;
            border: 2px solid #ccc;
            flex-shrink: 0;
        }
        #timer-display {
            font-weight: bold;
            color: #333;
            font-family: 'Courier New', Courier, monospace;
        }
        /* Utility class to hide elements */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>
    <div class="common nav">
        <a href="index.html">Scratch</a>
    </div>
    <div id="start-screen">
        <div id="start-box">
            <h2>Welcome to Alchemist's Apprentice!</h2>
            <p>
                Your goal is to brew the target potion shown at the top left.
                Start with the Water Bottle (top right) and click the ingredients
                in the correct order. Make three mistakes on a step, and you'll get a hint!
                Good luck, apprentice!
            </p>
            <button id="start-game-button">Start Brewing!</button>
        </div>
    </div>

    <div id="game-container" class="hidden"> <h1 class="text-2xl font-bold text-center mb-4 text-gray-700">Alchemist's Apprentice</h1>

        <div class="potion-display-area">
            <div class="potion-display">
                <div class="section-title">Target Potion</div>
                <img id="target-potion-img" src="assets/placeholder.png" alt="Target Potion"> <span id="target-potion-name">Loading...</span>
            </div>
            <div class="potion-display">
                <div class="section-title">Current Potion</div>
                <img id="current-potion-img" src="assets/potion_water.png" alt="Current Potion"> <span id="current-potion-name">Water Bottle</span>
            </div>
        </div>

        <div id="timer-container">
             Time Elapsed: <span id="timer-display">0.000s</span>
        </div>

        <div class="section-title">Select Ingredient</div>
        <div id="ingredient-grid">
            </div> <div id="feedback">Select the first ingredient!</div>

        <button id="new-game-button">New Game</button>
    </div> <script>
        // --- DATA ---
        const PLACEHOLDER_IMAGE_SRC = "assets/placeholder.png"; // Use a local placeholder if needed

        // --- Potion Recipes Data ---
        // UPDATED: Image paths point to local 'assets' folder
        const POTION_RECIPES = {
            "Potion of Swiftness": { steps: ["Nether Wart", "Sugar"], image: "assets/potion_swiftness.png", base: "Awkward Potion" },
            "Potion of Leaping": { steps: ["Nether Wart", "Rabbit's Foot"], image: "assets/potion_leaping.png", base: "Awkward Potion" },
            "Potion of Strength": { steps: ["Nether Wart", "Blaze Powder"], image: "assets/potion_strength.png", base: "Awkward Potion" },
            "Potion of Healing": { steps: ["Nether Wart", "Glistering Melon Slice"], image: "assets/potion_healing.png", base: "Awkward Potion" },
            "Potion of Poison": { steps: ["Nether Wart", "Spider Eye"], image: "assets/potion_poison.png", base: "Awkward Potion" },
            "Potion of Regeneration": { steps: ["Nether Wart", "Ghast Tear"], image: "assets/potion_regeneration.png", base: "Awkward Potion" },
            "Potion of Fire Resistance": { steps: ["Nether Wart", "Magma Cream"], image: "assets/potion_fire_resistance.png", base: "Awkward Potion" },
            "Potion of Water Breathing": { steps: ["Nether Wart", "Pufferfish"], image: "assets/potion_water_breathing.png", base: "Awkward Potion" },
            "Potion of Night Vision": { steps: ["Nether Wart", "Golden Carrot"], image: "assets/potion_night_vision.png", base: "Awkward Potion" },
            "Potion of Slow Falling": { steps: ["Nether Wart", "Phantom Membrane"], image: "assets/potion_slow_falling.png", base: "Awkward Potion" },
            "Potion of the Turtle Master": { steps: ["Nether Wart", "Turtle Shell"], image: "assets/potion_turtle_master.png", base: "Awkward Potion" },
            "Potion of Weakness": { steps: ["Fermented Spider Eye"], image: "assets/potion_weakness.png", base: "Water Bottle" },
            "Potion of Strength II": { steps: ["Nether Wart", "Blaze Powder", "Glowstone Dust"], image: "assets/potion_strength.png", base: "Awkward Potion" }, // Reusing base image, update if you have II specific
            "Potion of Leaping II": { steps: ["Nether Wart", "Rabbit's Foot", "Glowstone Dust"], image: "assets/potion_leaping.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Healing II": { steps: ["Nether Wart", "Glistering Melon Slice", "Glowstone Dust"], image: "assets/potion_healing.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Poison II": { steps: ["Nether Wart", "Spider Eye", "Glowstone Dust"], image: "assets/potion_poison.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Swiftness II": { steps: ["Nether Wart", "Sugar", "Glowstone Dust"], image: "assets/potion_swiftness.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Swiftness (8:00)": { steps: ["Nether Wart", "Sugar", "Redstone Dust"], image: "assets/potion_swiftness.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Leaping (8:00)": { steps: ["Nether Wart", "Rabbit's Foot", "Redstone Dust"], image: "assets/potion_leaping.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Strength (8:00)": { steps: ["Nether Wart", "Blaze Powder", "Redstone Dust"], image: "assets/potion_strength.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Poison (1:30)": { steps: ["Nether Wart", "Spider Eye", "Redstone Dust"], image: "assets/potion_poison.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Regeneration (1:30)": { steps: ["Nether Wart", "Ghast Tear", "Redstone Dust"], image: "assets/potion_regeneration.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Fire Resistance (8:00)": { steps: ["Nether Wart", "Magma Cream", "Redstone Dust"], image: "assets/potion_fire_resistance.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Water Breathing (8:00)": { steps: ["Nether Wart", "Pufferfish", "Redstone Dust"], image: "assets/potion_water_breathing.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Night Vision (8:00)": { steps: ["Nether Wart", "Golden Carrot", "Redstone Dust"], image: "assets/potion_night_vision.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Slow Falling (4:00)": { steps: ["Nether Wart", "Phantom Membrane", "Redstone Dust"], image: "assets/potion_slow_falling.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Weakness (4:00)": { steps: ["Fermented Spider Eye", "Redstone Dust"], image: "assets/potion_weakness.png", base: "Water Bottle" }, // Reusing base image
            "Potion of Harming": { steps: ["Nether Wart", "Glistering Melon Slice", "Fermented Spider Eye"], image: "assets/potion_harming.png", base: "Awkward Potion" },
            "Potion of Harming II": { steps: ["Nether Wart", "Glistering Melon Slice", "Glowstone Dust", "Fermented Spider Eye"], image: "assets/potion_harming.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Slowness": { steps: ["Nether Wart", "Sugar", "Fermented Spider Eye"], image: "assets/potion_slowness.png", base: "Awkward Potion" },
            "Potion of Slowness (4:00)": { steps: ["Nether Wart", "Sugar", "Redstone Dust", "Fermented Spider Eye"], image: "assets/potion_slowness.png", base: "Awkward Potion" }, // Reusing base image
            "Potion of Invisibility": { steps: ["Nether Wart", "Golden Carrot", "Fermented Spider Eye"], image: "assets/potion_invisibility.png", base: "Awkward Potion" },
            "Potion of Invisibility (8:00)": { steps: ["Nether Wart", "Golden Carrot", "Redstone Dust", "Fermented Spider Eye"], image: "assets/potion_invisibility.png", base: "Awkward Potion" }, // Reusing base image
            "Splash Potion of Swiftness": { steps: ["Nether Wart", "Sugar", "Gunpowder"], image: "assets/splash_potion_swiftness.png", base: "Awkward Potion" },
            "Splash Potion of Leaping": { steps: ["Nether Wart", "Rabbit's Foot", "Gunpowder"], image: "assets/splash_potion_leaping.png", base: "Awkward Potion" },
            "Splash Potion of Strength": { steps: ["Nether Wart", "Blaze Powder", "Gunpowder"], image: "assets/splash_potion_strength.png", base: "Awkward Potion" },
            "Splash Potion of Healing": { steps: ["Nether Wart", "Glistering Melon Slice", "Gunpowder"], image: "assets/splash_potion_healing.png", base: "Awkward Potion" },
            "Splash Potion of Poison": { steps: ["Nether Wart", "Spider Eye", "Gunpowder"], image: "assets/splash_potion_poison.png", base: "Awkward Potion" },
            "Splash Potion of Regeneration": { steps: ["Nether Wart", "Ghast Tear", "Gunpowder"], image: "assets/splash_potion_regeneration.png", base: "Awkward Potion" },
            "Splash Potion of Fire Resistance": { steps: ["Nether Wart", "Magma Cream", "Gunpowder"], image: "assets/splash_potion_fire_resistance.png", base: "Awkward Potion" },
            "Splash Potion of Water Breathing": { steps: ["Nether Wart", "Pufferfish", "Gunpowder"], image: "assets/splash_potion_water_breathing.png", base: "Awkward Potion" },
            "Splash Potion of Night Vision": { steps: ["Nether Wart", "Golden Carrot", "Gunpowder"], image: "assets/splash_potion_night_vision.png", base: "Awkward Potion" },
            "Splash Potion of Weakness": { steps: ["Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_weakness.png", base: "Water Bottle" },
            "Splash Potion of Strength II": { steps: ["Nether Wart", "Blaze Powder", "Glowstone Dust", "Gunpowder"], image: "assets/splash_potion_strength.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Leaping II": { steps: ["Nether Wart", "Rabbit's Foot", "Glowstone Dust", "Gunpowder"], image: "assets/splash_potion_leaping.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Healing II": { steps: ["Nether Wart", "Glistering Melon Slice", "Glowstone Dust", "Gunpowder"], image: "assets/splash_potion_healing.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Poison II": { steps: ["Nether Wart", "Spider Eye", "Glowstone Dust", "Gunpowder"], image: "assets/splash_potion_poison.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Swiftness II": { steps: ["Nether Wart", "Sugar", "Glowstone Dust", "Gunpowder"], image: "assets/splash_potion_swiftness.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Swiftness (8:00)": { steps: ["Nether Wart", "Sugar", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_swiftness.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Leaping (8:00)": { steps: ["Nether Wart", "Rabbit's Foot", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_leaping.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Strength (8:00)": { steps: ["Nether Wart", "Blaze Powder", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_strength.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Poison (1:30)": { steps: ["Nether Wart", "Spider Eye", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_poison.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Regeneration (1:30)": { steps: ["Nether Wart", "Ghast Tear", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_regeneration.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Fire Resistance (8:00)": { steps: ["Nether Wart", "Magma Cream", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_fire_resistance.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Water Breathing (8:00)": { steps: ["Nether Wart", "Pufferfish", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_water_breathing.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Night Vision (8:00)": { steps: ["Nether Wart", "Golden Carrot", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_night_vision.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Weakness (4:00)": { steps: ["Fermented Spider Eye", "Redstone Dust", "Gunpowder"], image: "assets/splash_potion_weakness.png", base: "Water Bottle" }, // Reusing base splash
            "Splash Potion of Harming": { steps: ["Nether Wart", "Glistering Melon Slice", "Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_harming.png", base: "Awkward Potion" },
            "Splash Potion of Harming II": { steps: ["Nether Wart", "Glistering Melon Slice", "Glowstone Dust", "Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_harming.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Slowness": { steps: ["Nether Wart", "Sugar", "Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_slowness.png", base: "Awkward Potion" },
            "Splash Potion of Slowness (4:00)": { steps: ["Nether Wart", "Sugar", "Redstone Dust", "Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_slowness.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Invisibility": { steps: ["Nether Wart", "Golden Carrot", "Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_invisibility.png", base: "Awkward Potion" },
            "Splash Potion of Invisibility (8:00)": { steps: ["Nether Wart", "Golden Carrot", "Redstone Dust", "Fermented Spider Eye", "Gunpowder"], image: "assets/splash_potion_invisibility.png", base: "Awkward Potion" }, // Reusing base splash
            "Splash Potion of Slow Falling": { steps: ["Nether Wart", "Phantom Membrane", "Gunpowder"], image: "assets/splash_potion_slow_falling.png", base: "Awkward Potion" },
            "Splash Potion of the Turtle Master": { steps: ["Nether Wart", "Turtle Shell", "Gunpowder"], image: "assets/splash_potion_turtle_master.png", base: "Awkward Potion" },
            "Lingering Potion of Swiftness": { steps: ["Nether Wart", "Sugar", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_swiftness.png", base: "Awkward Potion" },
            "Lingering Potion of Leaping": { steps: ["Nether Wart", "Rabbit's Foot", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_leaping.png", base: "Awkward Potion" },
            "Lingering Potion of Strength": { steps: ["Nether Wart", "Blaze Powder", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_strength.png", base: "Awkward Potion" },
            "Lingering Potion of Healing": { steps: ["Nether Wart", "Glistering Melon Slice", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_healing.png", base: "Awkward Potion" },
            "Lingering Potion of Poison": { steps: ["Nether Wart", "Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_poison.png", base: "Awkward Potion" },
            "Lingering Potion of Regeneration": { steps: ["Nether Wart", "Ghast Tear", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_regeneration.png", base: "Awkward Potion" },
            "Lingering Potion of Fire Resistance": { steps: ["Nether Wart", "Magma Cream", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_fire_resistance.png", base: "Awkward Potion" },
            "Lingering Potion of Water Breathing": { steps: ["Nether Wart", "Pufferfish", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_water_breathing.png", base: "Awkward Potion" },
            "Lingering Potion of Night Vision": { steps: ["Nether Wart", "Golden Carrot", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_night_vision.png", base: "Awkward Potion" },
            "Lingering Potion of Weakness": { steps: ["Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_weakness.png", base: "Water Bottle" },
            "Lingering Potion of Strength II": { steps: ["Nether Wart", "Blaze Powder", "Glowstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_strength.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Leaping II": { steps: ["Nether Wart", "Rabbit's Foot", "Glowstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_leaping.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Healing II": { steps: ["Nether Wart", "Glistering Melon Slice", "Glowstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_healing.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Poison II": { steps: ["Nether Wart", "Spider Eye", "Glowstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_poison.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Swiftness II": { steps: ["Nether Wart", "Sugar", "Glowstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_swiftness.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Swiftness (8:00)": { steps: ["Nether Wart", "Sugar", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_swiftness.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Leaping (8:00)": { steps: ["Nether Wart", "Rabbit's Foot", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_leaping.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Strength (8:00)": { steps: ["Nether Wart", "Blaze Powder", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_strength.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Poison (1:30)": { steps: ["Nether Wart", "Spider Eye", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_poison.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Regeneration (1:30)": { steps: ["Nether Wart", "Ghast Tear", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_regeneration.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Fire Resistance (8:00)": { steps: ["Nether Wart", "Magma Cream", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_fire_resistance.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Water Breathing (8:00)": { steps: ["Nether Wart", "Pufferfish", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_water_breathing.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Night Vision (8:00)": { steps: ["Nether Wart", "Golden Carrot", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_night_vision.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Weakness (4:00)": { steps: ["Fermented Spider Eye", "Redstone Dust", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_weakness.png", base: "Water Bottle" }, // Reusing base lingering
            "Lingering Potion of Harming": { steps: ["Nether Wart", "Glistering Melon Slice", "Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_harming.png", base: "Awkward Potion" },
            "Lingering Potion of Harming II": { steps: ["Nether Wart", "Glistering Melon Slice", "Glowstone Dust", "Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_harming.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Slowness": { steps: ["Nether Wart", "Sugar", "Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_slowness.png", base: "Awkward Potion" },
            "Lingering Potion of Slowness (4:00)": { steps: ["Nether Wart", "Sugar", "Redstone Dust", "Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_slowness.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Invisibility": { steps: ["Nether Wart", "Golden Carrot", "Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_invisibility.png", base: "Awkward Potion" },
            "Lingering Potion of Invisibility (8:00)": { steps: ["Nether Wart", "Golden Carrot", "Redstone Dust", "Fermented Spider Eye", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_invisibility.png", base: "Awkward Potion" }, // Reusing base lingering
            "Lingering Potion of Slow Falling": { steps: ["Nether Wart", "Phantom Membrane", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_slow_falling.png", base: "Awkward Potion" },
            "Lingering Potion of the Turtle Master": { steps: ["Nether Wart", "Turtle Shell", "Gunpowder", "Dragon's Breath"], image: "assets/lingering_potion_turtle_master.png", base: "Awkward Potion" },
        };

        // --- Intermediate Potion Data ---
        const INTERMEDIATE_POTIONS = {
             "Nether Wart": { name: "Awkward Potion", image: "assets/potion_awkward.png" }, // Updated path
             // Add more intermediate display logic if needed
        };

        // --- Ingredient Data ---
        // UPDATED: Image paths point to local 'assets' folder
        const INGREDIENTS = {
            "Nether Wart": { image: "assets/nether_wart.png" }, "Sugar": { image: "assets/sugar.png" }, "Rabbit's Foot": { image: "assets/rabbits_foot.png" },
            "Blaze Powder": { image: "assets/blaze_powder.png" }, "Glistering Melon Slice": { image: "assets/glistering_melon_slice.png" }, "Spider Eye": { image: "assets/spider_eye.png" },
            "Ghast Tear": { image: "assets/ghast_tear.png" }, "Magma Cream": { image: "assets/magma_cream.png" }, "Pufferfish": { image: "assets/pufferfish.png" },
            "Golden Carrot": { image: "assets/golden_carrot.png" }, "Turtle Shell": { image: "assets/turtle_shell.png" }, "Phantom Membrane": { image: "assets/phantom_membrane.png" },
            "Fermented Spider Eye": { image: "assets/fermented_spider_eye.png" }, "Glowstone Dust": { image: "assets/glowstone_dust.png" }, "Redstone Dust": { image: "assets/redstone_dust.png" },
            "Gunpowder": { image: "assets/gunpowder.png" }, "Dragon's Breath": { image: "assets/dragons_breath.png" }
        };

        // --- DOM Element References ---
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const startGameButton = document.getElementById('start-game-button');
        const targetPotionImg = document.getElementById('target-potion-img');
        const targetPotionName = document.getElementById('target-potion-name');
        const currentPotionImg = document.getElementById('current-potion-img');
        const currentPotionName = document.getElementById('current-potion-name');
        const ingredientGrid = document.getElementById('ingredient-grid');
        const feedback = document.getElementById('feedback');
        const newGameButton = document.getElementById('new-game-button');
        const timerDisplay = document.getElementById('timer-display');

        // --- Game State Variables ---
        let targetPotionKey = null;
        let currentRecipe = [];
        let stepsTaken = 0;
        let isGameOver = false;
        let startTime = 0;
        let timerInterval = null;
        let penaltyTimeout = null;
        let incorrectGuessesCurrentStep = 0;
        let gameHasStarted = false;

        // --- Helper Function: Image Error Handling ---
        function setImage(imgElement, src, altText) {
            // Sets image source and provides fallback behavior
            imgElement.src = src || PLACEHOLDER_IMAGE_SRC;
            imgElement.alt = altText;
            imgElement.onerror = () => {
                // If the local image fails, maybe show text or a generic placeholder
                imgElement.src = PLACEHOLDER_IMAGE_SRC;
                console.warn(`Failed to load image: ${src}`);
            };
            imgElement.onload = () => { }; // Reset any potential error state styling if needed
        }

        // --- Timer Control Functions ---
        function startTimer() {
            if (!gameHasStarted) return;
            startTime = performance.now();
            if (timerInterval) clearInterval(timerInterval);
            timerDisplay.textContent = '0.000s';
            timerInterval = setInterval(updateTimerDisplay, 50);
        }
        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            const finalTimeMs = startTime > 0 ? performance.now() - startTime : 0;
            timerDisplay.textContent = `${(finalTimeMs / 1000).toFixed(3)}s`;
            return finalTimeMs;
        }
        function updateTimerDisplay() {
            if (!isGameOver && startTime > 0 && gameHasStarted) {
                 const elapsedTime = performance.now() - startTime;
                 timerDisplay.textContent = `${(elapsedTime / 1000).toFixed(3)}s`;
            }
        }
        function resetTimer() {
            stopTimer(); startTime = 0; timerDisplay.textContent = '0.000s';
        }

        // --- Penalty Functions ---
        function applyPenalty() {
            const cards = ingredientGrid.querySelectorAll('.ingredient-card');
            cards.forEach(card => card.classList.add('disabled'));
            if (penaltyTimeout) clearTimeout(penaltyTimeout);
            penaltyTimeout = setTimeout(() => {
                removePenalty(); penaltyTimeout = null;
            }, 3000);
        }
        function removePenalty() {
            const cards = ingredientGrid.querySelectorAll('.ingredient-card');
            cards.forEach(card => card.classList.remove('disabled'));
        }

        // --- Core Game Logic Functions ---
        function getRandomPotionKey() {
            const keys = Object.keys(POTION_RECIPES);
            return keys[Math.floor(Math.random() * keys.length)];
        }
        function getPotionData(potionKey) {
             // Use local paths now
             if (potionKey === "Water Bottle") return { name: "Water Bottle", image: "assets/potion_water.png" };
             if (potionKey === "Awkward Potion") return { name: "Awkward Potion", image: "assets/potion_awkward.png" };
             if (POTION_RECIPES[potionKey]) {
                 // Ensure the path uses the assets folder
                 let imagePath = POTION_RECIPES[potionKey].image;
                 if (!imagePath.startsWith('assets/')) {
                     // Basic correction if path is missing prefix (might need adjustment)
                     imagePath = `assets/${imagePath.split('/').pop()}`;
                 }
                 return { name: potionKey, image: imagePath };
             }
             // Check intermediate states (simplified)
             const lastIngredient = currentRecipe.length > 0 ? currentRecipe[currentRecipe.length - 1] : null;
             if (lastIngredient && INTERMEDIATE_POTIONS[lastIngredient]) {
                  // Ensure the path uses the assets folder
                 let imagePath = INTERMEDIATE_POTIONS[lastIngredient].image;
                  if (!imagePath.startsWith('assets/')) {
                     imagePath = `assets/${imagePath.split('/').pop()}`;
                 }
                 return { name: INTERMEDIATE_POTIONS[lastIngredient].name, image: imagePath };
             }
             // Fallback
             return { name: "Unknown Potion", image: PLACEHOLDER_IMAGE_SRC };
        }

        function updateDisplay() {
            const targetData = getPotionData(targetPotionKey);
            setImage(targetPotionImg, targetData.image, targetData.name);
            targetPotionName.textContent = targetData.name;

            let currentPotionDisplayKey = "Water Bottle";
             if (stepsTaken > 0 && targetPotionKey && POTION_RECIPES[targetPotionKey]) {
                 const recipe = POTION_RECIPES[targetPotionKey];
                 const recipeSteps = recipe.steps;

                 if (stepsTaken === recipeSteps.length) {
                     currentPotionDisplayKey = targetPotionKey;
                 } else if (stepsTaken > 0 && stepsTaken < recipeSteps.length) {
                     let intermediateKey = Object.keys(POTION_RECIPES).find(key => {
                         const iRecipe = POTION_RECIPES[key];
                         if (iRecipe.steps.length === stepsTaken && recipe.base === iRecipe.base) {
                             return recipeSteps.slice(0, stepsTaken).every((step, i) => step === iRecipe.steps[i]);
                         }
                         return false;
                     });
                     if (intermediateKey) {
                         currentPotionDisplayKey = intermediateKey;
                     } else if (currentRecipe[0] === "Nether Wart") {
                          currentPotionDisplayKey = "Awkward Potion";
                     } else if (currentRecipe[0] === "Fermented Spider Eye" && recipe.base === "Water Bottle") {
                         currentPotionDisplayKey = "Potion of Weakness";
                     } else {
                         currentPotionDisplayKey = "Intermediate";
                     }
                 }
             }
            const currentData = getPotionData(currentPotionDisplayKey);
            setImage(currentPotionImg, currentData.image, currentData.name);
            currentPotionName.textContent = currentData.name;
        }

        // Fisher-Yates (aka Knuth) Shuffle algorithm
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex > 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function populateIngredients() {
            ingredientGrid.innerHTML = '';
            const ingredientKeys = Object.keys(INGREDIENTS);
            const shuffledKeys = shuffleArray(ingredientKeys);

            shuffledKeys.forEach(ingredientKey => {
                const card = document.createElement('div');
                card.className = 'ingredient-card';
                card.dataset.ingredient = ingredientKey;
                const img = document.createElement('img');
                // Use local path from INGREDIENTS object
                setImage(img, INGREDIENTS[ingredientKey].image, ingredientKey);
                const span = document.createElement('span');
                span.textContent = ingredientKey;
                card.appendChild(img);
                card.appendChild(span);
                card.addEventListener('click', () => handleIngredientSelect(ingredientKey));
                ingredientGrid.appendChild(card);
            });
        }

        function handleIngredientSelect(selectedIngredient) {
            if (!gameHasStarted || isGameOver) return;
            if (!targetPotionKey || !POTION_RECIPES[targetPotionKey]) {
                console.error("Game Error: Target potion data missing."); return;
            }
            const targetRecipeSteps = POTION_RECIPES[targetPotionKey].steps;

            if (stepsTaken < targetRecipeSteps.length) {
                const expectedIngredient = targetRecipeSteps[stepsTaken];
                if (selectedIngredient === expectedIngredient) {
                    incorrectGuessesCurrentStep = 0;
                    stepsTaken++; currentRecipe.push(selectedIngredient);
                    feedback.textContent = `Correct! Added ${selectedIngredient}.`;
                    feedback.style.backgroundColor = '#dff0d8';
                    updateDisplay();
                    if (stepsTaken === targetRecipeSteps.length) {
                        isGameOver = true; const finalTimeMs = stopTimer();
                        const finalTimeSec = finalTimeMs / 1000;
                        let timeMessage = ` in ${finalTimeSec.toFixed(3)} seconds!`;
                        if (finalTimeSec < 10) timeMessage += " Lightning!";
                        else if (finalTimeSec > 60) timeMessage += " Perchance, have you taken a slowness potion recently?";
                        feedback.textContent = `Success! You brewed the ${targetPotionKey}${timeMessage}`;
                        feedback.style.backgroundColor = '#a8e6cf';
                    }
                } else {
                    incorrectGuessesCurrentStep++;
                    if (incorrectGuessesCurrentStep >= 3) {
                         feedback.textContent = `Incorrect ingredient. Still need ${expectedIngredient}. Try again! (Penalty applied)`;
                    } else {
                         feedback.textContent = `Incorrect ingredient. Try again! (Penalty applied)`;
                    }
                    feedback.style.backgroundColor = '#f2dede';
                    applyPenalty();
                }
            }
        }

        function setupNewRound() {
            targetPotionKey = getRandomPotionKey(); currentRecipe = []; stepsTaken = 0; isGameOver = false;
            incorrectGuessesCurrentStep = 0;
            if (penaltyTimeout) clearTimeout(penaltyTimeout); removePenalty();
            feedback.textContent = 'Select the first ingredient!'; feedback.style.backgroundColor = '#fffacd';
            resetTimer();
            updateDisplay();
            populateIngredients();
        }

        // --- Event Listeners ---
        startGameButton.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            gameHasStarted = true;
            setupNewRound();
            startTimer(); // Start timer only after setup and game start
        });

        newGameButton.addEventListener('click', () => {
            if (!gameHasStarted) return;
            setupNewRound();
            startTimer(); // Start timer for the new round
        });

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             startScreen.classList.remove('hidden');
             gameContainer.classList.add('hidden');
             // Set initial placeholder images using local paths
             setImage(targetPotionImg, PLACEHOLDER_IMAGE_SRC, "Target Potion");
             setImage(currentPotionImg, "assets/potion_water.png", "Water Bottle");
        });

    </script>
</body>
</html>